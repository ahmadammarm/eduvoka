// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
    provider = "prisma-client"
    output   = "../generated/prisma"
}

datasource db {
    provider = "mysql"
}

enum SoalUTBKType {
    PU // Pengetahuan Umum
    PBM // Pemahaman Bacaan & Menulis
    PPU // Pengetahuan & Pemahaman Umum
    PK // Pengetahuan Kuantitatif
    LITERASIBINDO
    LITERASIBINGG
}

enum Role {
    USER
    ADMIN
}

enum GayaBelajar {
    VISUAL
    AUDITORY
    KINESTHETIC
}

enum TipeSoal {
    TPS
    LITERASI
}

enum PaketUser {
    BASIC
    LITE
    ACTIVE
    EDUVOKA
}

model User {
    id                String       @id @default(uuid())
    email             String       @unique
    name              String
    password          String?
    profileImage      String?
    createdAt         DateTime     @default(now())
    updatedAt         DateTime
    gayaBelajar       GayaBelajar?
    role              Role         @default(USER)
    paketUser         PaketUser    @default(BASIC)
    isSubscribed      Boolean      @default(false)
    subscriptionEndAt DateTime?

    accounts Account[]
    sessions Session[]

    jawabanUserKuisVAKs JawabanUserKuisVAK[]
    utbkSessions        UtbkSession[]
}

model Account {
    id                String  @id @default(uuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(uuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PertanyaanKuisVAK {
    id         String   @id @default(uuid())
    pertanyaan String   @db.Text
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    jawabanKuisVAKs JawabanKuisVAK[]

    jawabanUserKuisVAKs JawabanUserKuisVAK[]
}

model JawabanKuisVAK {
    id String @id @default(uuid())

    kuisVAKId   String
    jawaban     String
    tipeJawaban GayaBelajar
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    kuisVAK             PertanyaanKuisVAK    @relation(fields: [kuisVAKId], references: [id], onDelete: Cascade)
    jawabanUserKuisVAKs JawabanUserKuisVAK[]
}

model JawabanUserKuisVAK {
    id                  String @id @default(uuid())
    userId              String
    pertanyaanKuisVAKId String
    jawabanKuisVAKId    String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
    pertanyaanKuisVAK PertanyaanKuisVAK @relation(fields: [pertanyaanKuisVAKId], references: [id], onDelete: Cascade)
    jawabanKuisVAK    JawabanKuisVAK    @relation(fields: [jawabanKuisVAKId], references: [id], onDelete: Cascade)

    @@unique([userId, pertanyaanKuisVAKId])
}

model SoalUTBK {
    id           String       @id
    tipe         SoalUTBKType
    content      String       @db.Text
    kunciJawaban String

    pilihanJawaban PilihanJawaban[]
    pembahasan     PembahasanSoalUTBK[]
    jawabanUser    UtbkJawabanUser[]
}

model PilihanJawaban {
    id         String @id
    soalUTBKId String
    label      String // A, B, C, D, E
    pilihan    String

    soalUTBK    SoalUTBK          @relation(fields: [soalUTBKId], references: [id], onDelete: Cascade, map: "PilihanJawaban_soalUTBKId_fkey")
    jawabanUser UtbkJawabanUser[]

    @@index([soalUTBKId], map: "PilihanJawaban_soalUTBKId_fkey")
}

model PembahasanSoalUTBK {
    id          String      @id
    soalUTBKId  String
    gayaBelajar GayaBelajar
    konten      String      @db.Text
    createdAt   DateTime    @default(now())
    updatedAt   DateTime

    soalUTBK SoalUTBK @relation(fields: [soalUTBKId], references: [id], onDelete: Cascade)

    @@unique([soalUTBKId, gayaBelajar])
    @@index([soalUTBKId])
}

model UtbkSession {
    id        String    @id
    userId    String
    startedAt DateTime  @default(now())
    endedAt   DateTime?
    score     Int?

    user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
    jawaban UtbkJawabanUser[]

    @@index([userId])
}

model UtbkJawabanUser {
    id         String    @id
    sessionId  String
    soalUTBKId String
    pilihanId  String? // null jika tidak dijawab
    isCorrect  Boolean?
    answeredAt DateTime?

    session        UtbkSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
    soalUTBK       SoalUTBK        @relation(fields: [soalUTBKId], references: [id], onDelete: Cascade)
    pilihanJawaban PilihanJawaban? @relation(fields: [pilihanId], references: [id])

    @@unique([sessionId, soalUTBKId])
    @@index([soalUTBKId])
}
