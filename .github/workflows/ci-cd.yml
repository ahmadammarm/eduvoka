name: CI/CD Eduvoka

on:
  pull_request:
    branches:
      - "*"
  push:
    branches:
      - development
      - main

env:
  NODE_VERSION: "20"

jobs:
  branch-name-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check Branch Name
        run: |
          # Extract branch name from ref
          branch="${GITHUB_REF#refs/heads/}"
          if [ -n "$GITHUB_HEAD_REF" ]; then
            branch="$GITHUB_HEAD_REF"
          fi
          echo "Current branch: $branch"

          # Skip check for main, development branches
          if [[ "$branch" == "main" || "$branch" == "development" ]]; then
            echo "Skipping branch name check for $branch"
            exit 0
          fi

          # Validate branch name against allowed prefixes
          if [[ $branch =~ ^(feat/|fix/|hotfix/|release/|docs/|chore/|refactor/|dependabot|copilot) ]]; then
            echo "Branch name is valid."
          else
            echo "Invalid branch name: $branch. Branch name must start with one of: feat/, fix/, hotfix/, release/, docs/, chore/, refactor/, dependabot, or copilot."
            exit 1
          fi

  changelog-check:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check CHANGELOG.md Changes
        run: |
          echo "Checking if CHANGELOG.md has been modified..."

          # Get the base branch
          base_branch="${{ github.event.pull_request.base.ref }}"
          echo "Base branch: $base_branch"

          # Fetch the base branch
          git fetch origin "$base_branch"

          # Check if CHANGELOG.md is in the list of changed files
          changed_files=$(git diff --name-only "origin/$base_branch"...HEAD)
          echo "Changed files:"
          echo "$changed_files"

          if echo "$changed_files" | grep -q "^CHANGELOG.md$"; then
            echo "CHANGELOG.md has been modified in this PR."
          else
            echo "CHANGELOG.md has NOT been modified in this PR."
            echo ""
            echo "Please update CHANGELOG.md with your changes before merging."
            echo "Add an entry under the appropriate section (Added, Changed, Fixed, etc.)"
            echo "following the format in the existing changelog."
            exit 1
          fi

      - name: Validate CHANGELOG Format
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "CHANGELOG.md not found"
            exit 1
          fi

          if ! grep -Eq '^## \[(Unreleased|[0-9]+\.[0-9]+\.[0-9]+(-beta\.[0-9]+|-rc\.[0-9]+)?)\]' CHANGELOG.md; then
            echo "Invalid CHANGELOG format. Must follow Keep a Changelog format."
            exit 1
          fi

          echo "CHANGELOG format is valid."

  build:
    runs-on: ubuntu-latest
    needs: [branch-name-check]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Create .env file
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL_STAGING }}" > .env

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}

  deploy-staging:
    if: github.event_name == 'push' && github.ref == 'refs/heads/development'
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Create .env file
        run: |
          echo "DATABASE_URL=${{ secrets.DATABASE_URL_STAGING }}" > .env

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Prisma migrate (staging)
        run: pnpm prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}

      - name: Build application
        run: pnpm build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_STAGING }}

      - name: Install Vercel CLI
        run: pnpm add -g vercel

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel (Staging)
        id: deploy-staging
        run: |
          URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "### Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** $URL" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** development" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}